AWSTemplateFormatVersion: 2010-09-09
Description: 4.1.6 Elastic IP
Parameters:
  LinuxAMI:
    Type: String
    Description: Amazon Linux AMI ID
  InstanceType:
    Type: String
    Description: Instance Type
  EC2KeyPair:
    Type: String
    Description: EC2 KeyPair

Resources:
  EC2:
    Type: AWS::EC2::Instance
    Properties: 
      InstanceType: !Ref InstanceType
      ImageId: !Ref LinuxAMI
      KeyName: !Ref EC2KeyPair
      Tags: 
      - Key: "Name"
        Value: "ringer-stelligent"
      - Key: "user"
        Value: "gringer_aa"
      - Key: "stelligent-u-lesson"
        Value: "4"
      - Key: "stelligent-u-lab"
        Value: "4.1.4"
      NetworkInterfaces:
      - AssociatePublicIpAddress: True
        DeleteOnTermination: True
        SubnetId:
          !ImportValue SubnetId
        DeviceIndex: '0'
        GroupSet:
          - Ref: SecurityGroup

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ICMP (for ping) and ssh traffic into your instance.
      VpcId:
        !ImportValue VPCID
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 0.0.0.0/0
      - IpProtocol: icmp 
        FromPort: 8
        ToPort: -1
        CidrIp: 0.0.0.0/0

  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      InstanceId: !Ref EC2

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !ImportValue VPCID

  PrivateRoutes:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !ImportValue IGExport   

Outputs:
  InstanceID:
    Description: Instance ID
    Value: !Ref EC2
    Export:
      Name: Ringer-EC2-ID
  InstancePrivateIP:
    Description: EC2 Instance Privte IP address
    Value: !GetAtt EC2.PrivateIp
    Export:
      Name: Ringer-EC2-Private-IP
  InstancePublicIP:
    Description: EC2 Instance Public IP address
    Value: !GetAtt EC2.PublicIp
    Export:
      Name: Ringer-EC2-Public-IP